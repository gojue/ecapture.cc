# Configuration System

<details>
<summary>Relevant source files</summary>

The following files were used as context for generating this wiki page:

- [cli/cmd/bash.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/bash.go)
- [cli/cmd/gnutls.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/gnutls.go)
- [cli/cmd/gotls.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/gotls.go)
- [cli/cmd/mysqld.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/mysqld.go)
- [cli/cmd/nspr.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/nspr.go)
- [cli/cmd/postgres.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/postgres.go)
- [cli/cmd/root.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/root.go)
- [cli/cmd/tls.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/tls.go)
- [cli/cmd/zsh.go](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/zsh.go)
- [pkg/util/ws/client.go](https://github.com/gojue/ecapture/blob/0766a93b/pkg/util/ws/client.go)
- [pkg/util/ws/client_test.go](https://github.com/gojue/ecapture/blob/0766a93b/pkg/util/ws/client_test.go)
- [user/config/iconfig.go](https://github.com/gojue/ecapture/blob/0766a93b/user/config/iconfig.go)
- [user/module/imodule.go](https://github.com/gojue/ecapture/blob/0766a93b/user/module/imodule.go)
- [user/module/probe_openssl.go](https://github.com/gojue/ecapture/blob/0766a93b/user/module/probe_openssl.go)

</details>



The Configuration System manages module-specific settings, platform detection, library discovery, and parameter validation for ecapture's various capture modules. This system provides a unified interface for configuring TLS/SSL interception across different libraries (OpenSSL, Go TLS, GnuTLS, NSPR) and platforms (Linux, Android).

For information about how configurations are applied during module execution, see [Capture Modules](../3-capture-modules/index.md). For build-time configuration and compilation settings, see [Build System](../5-development-guide/5.1-build-system.md).

## Architecture Overview

The configuration system follows a hierarchical design with base configuration inherited by module-specific implementations:

```mermaid
graph TB
    BaseConfig["BaseConfig<br/>Common settings"]
    
    subgraph "Module Configurations"
        GoTLSConfig["GoTLSConfig<br/>Go binary analysis"]
        OpensslConfig["OpensslConfig<br/>OpenSSL/BoringSSL"]
        GnutlsConfig["GnutlsConfig<br/>GnuTLS library"]
        NsprConfig["NsprConfig<br/>NSPR/Firefox"]
    end
    
    subgraph "Platform Implementations"
        LinuxOpenSSL["config_openssl_linux.go<br/>Linux library detection"]
        AndroidOpenSSL["config_openssl_androidgki.go<br/>Android paths"]
        LinuxGnuTLS["config_gnutls_linux.go<br/>GnuTLS discovery"]
        LinuxNSPR["config_nspr_linux.go<br/>Firefox NSPR"]
    end
    
    subgraph "Configuration Flow"
        CLI["CLI Flags<br/>cobra commands"]
        Validation["Check() methods<br/>Platform detection"]
        ModuleSetup["Module Setup<br/>eBPF manager config"]
    end
    
    BaseConfig --> GoTLSConfig
    BaseConfig --> OpensslConfig
    BaseConfig --> GnutlsConfig
    BaseConfig --> NsprConfig
    
    OpensslConfig --> LinuxOpenSSL
    OpensslConfig --> AndroidOpenSSL
    GnutlsConfig --> LinuxGnuTLS
    NsprConfig --> LinuxNSPR
    
    CLI --> Validation
    Validation --> ModuleSetup
```

**Sources:** [user/config/config_gotls.go:77-93](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L77-L93), [user/config/config_openssl.go:39-53](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl.go#L39-L53), [user/config/config_gnutls.go:20-31](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gnutls.go#L20-L31), [user/config/config_nspr.go:20-25](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_nspr.go#L20-L25)

## Base Configuration Structure

All module configurations inherit from `BaseConfig`, which provides common functionality:

| Field | Type | Purpose |
|-------|------|---------|
| `PerCpuMapSize` | `int` | eBPF map size per CPU core |
| `Pid` | `uint32` | Target process ID filter |
| `Uid` | `uint32` | Target user ID filter |
| `Debug` | `bool` | Enable debug logging |

```mermaid
graph LR
    subgraph "BaseConfig Fields"
        PerCpuMapSize["PerCpuMapSize<br/>DefaultMapSizePerCpu"]
        ProcessFilters["Process Filters<br/>Pid, Uid"]
        GlobalVars["Global Variables<br/>EnableGlobalVar()"]
    end
    
    subgraph "Module Extensions"
        GoTLS["GoTLSConfig<br/>+ binary analysis"]
        OpenSSL["OpensslConfig<br/>+ library detection"]
        GnuTLS["GnutlsConfig<br/>+ version checking"]
    end
    
    PerCpuMapSize --> GoTLS
    ProcessFilters --> OpenSSL
    GlobalVars --> GnuTLS
```

**Sources:** [user/config/config_gotls.go:96-100](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L96-L100), [user/config/config_openssl.go:55-59](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl.go#L55-L59), [user/config/config_gnutls.go:33-37](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gnutls.go#L33-L37)

## Go TLS Configuration

The `GoTLSConfig` provides the most complex configuration logic, performing binary analysis of Go applications to extract symbol addresses and function offsets:

### Binary Analysis Pipeline

```mermaid
graph TD
    ElfOpen["elf.Open(path)<br/>Parse ELF header"]
    BuildInfo["buildinfo.ReadFile()<br/>Extract Go build info"]
    ArchCheck["Architecture validation<br/>amd64/arm64 support"]
    
    subgraph "PIE Mode Detection"
        PIECheck["Check buildmode=pie<br/>from BuildInfo.Settings"]
        SymTabRead["ReadTable()<br/>Parse .gopclntab section"]
        MagicFind["Find magic number<br/>Go version specific"]
    end
    
    subgraph "Symbol Resolution"
        WriteAddr["findPieSymbolAddr()<br/>GoTlsWriteFunc"]
        MasterAddr["findPieSymbolAddr()<br/>GoTlsMasterSecretFunc"]
        RetOffsets["findRetOffsetsPie()<br/>GoTlsReadFunc returns"]
    end
    
    ElfOpen --> BuildInfo
    BuildInfo --> ArchCheck
    ArchCheck --> PIECheck
    PIECheck --> SymTabRead
    SymTabRead --> MagicFind
    MagicFind --> WriteAddr
    WriteAddr --> MasterAddr
    MasterAddr --> RetOffsets
```

**Sources:** [user/config/config_gotls.go:102-190](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L102-L190), [user/config/config_gotls.go:281-325](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L281-L325), [user/config/config_gotls.go:327-357](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L327-L357)

### Symbol Address Resolution

The Go configuration resolves specific function addresses for uprobe attachment:

| Function | Constant | Purpose |
|----------|----------|---------|
| `crypto/tls.(*Conn).Read` | `GoTlsReadFunc` | TLS read interception |
| `crypto/tls.(*Conn).writeRecordLocked` | `GoTlsWriteFunc` | TLS write interception |
| `crypto/tls.(*Config).writeKeyLog` | `GoTlsMasterSecretFunc` | Master secret extraction |

```mermaid
graph LR
    subgraph "Function Symbols"
        ReadFunc["GoTlsReadFunc<br/>crypto/tls.(*Conn).Read"]
        WriteFunc["GoTlsWriteFunc<br/>writeRecordLocked"]
        MasterFunc["GoTlsMasterSecretFunc<br/>writeKeyLog"]
    end
    
    subgraph "Address Resolution"
        ReadAddrs["ReadTlsAddrs[]<br/>Return instruction offsets"]
        WriteAddr["GoTlsWriteAddr<br/>Function entry point"]
        MasterAddr["GoTlsMasterSecretAddr<br/>Keylog function"]
    end
    
    ReadFunc --> ReadAddrs
    WriteFunc --> WriteAddr
    MasterFunc --> MasterAddr
```

**Sources:** [user/config/config_gotls.go:31-35](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L31-L35), [user/config/config_gotls.go:88-91](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L88-L91), [user/config/config_gotls.go:168-182](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L168-L182)

## OpenSSL Configuration

OpenSSL configuration handles library discovery across different platforms and versions:

### Library Discovery Process

```mermaid
graph TD
    UserPath["User specified path<br/>--openssl flag"]
    AutoDetect["Automatic detection<br/>checkOpenssl()"]
    
    subgraph "Linux Detection"
        DynLibDirs["GetDynLibDirs()<br/>System library paths"]
        LibSearch["Search libraries<br/>libssl.so.3, libssl.so.1.1"]
        PathFound["Set Openssl path<br/>ElfType = ElfTypeSo"]
    end
    
    subgraph "Android Detection"  
        AndroidPath["DefaultOpensslPath<br/>/apex/com.android.conscrypt/"]
        AndroidVer["Parse build.prop<br/>ro.build.version.release"]
    end
    
    UserPath --> PathFound
    AutoDetect --> DynLibDirs
    DynLibDirs --> LibSearch
    LibSearch --> PathFound
    
    AutoDetect --> AndroidPath
    AndroidPath --> AndroidVer
```

**Sources:** [user/config/config_openssl_linux.go:38-67](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl_linux.go#L38-L67), [user/config/config_openssl_androidgki.go:34-71](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl_androidgki.go#L34-L71), [user/config/config_openssl.go:74-111](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl.go#L74-L111)

### Platform-Specific Paths

| Platform | Default Library Path | Interface |
|----------|---------------------|-----------|
| Linux | `/usr/lib/x86_64-linux-gnu/libssl.so.3` | `eth0` |
| Android | `/apex/com.android.conscrypt/lib64/libssl.so` | `wlan0` |

**Sources:** [user/config/config_openssl_linux.go:28-36](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl_linux.go#L28-L36), [user/config/config_openssl_androidgki.go:26-32](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl_androidgki.go#L26-L32)

## Capture Model Selection

All TLS modules support multiple capture models through the `checkModel()` method:

```mermaid
graph TD
    ModelInput["User Model Input<br/>--model flag"]
    
    subgraph "Model Types"
        TextModel["TlsCaptureModelText<br/>Default: plain text output"]
        KeyModel["TlsCaptureModelKey<br/>keylog/key: extract secrets"]
        PcapModel["TlsCaptureModelPcap<br/>pcap/pcapng: packet capture"]
    end
    
    subgraph "Validation"
        IfnameCheck["Pcap mode requires<br/>--ifname interface"]
        FileCheck["Key mode sets<br/>keylog file path"]
    end
    
    ModelInput --> TextModel
    ModelInput --> KeyModel
    ModelInput --> PcapModel
    
    PcapModel --> IfnameCheck
    KeyModel --> FileCheck
```

**Sources:** [user/config/config_gotls.go:264-279](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L264-L279), [user/config/config_openssl.go:61-72](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl.go#L61-L72), [user/config/config_gnutls.go:39-50](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gnutls.go#L39-L50)

## Configuration Validation

Each module implements a `Check()` method that performs comprehensive validation:

### Validation Flow

```mermaid
graph TD
    CheckStart["config.Check()"]
    
    subgraph "Common Validation"
        ModelCheck["checkModel()<br/>Validate capture mode"]
        PathCheck["os.Stat(path)<br/>Verify file exists"]
        PermCheck["Permission validation"]
    end
    
    subgraph "Go-Specific"
        BuildInfoRead["buildinfo.ReadFile()<br/>Go binary metadata"]
        ElfOpen["elf.Open()<br/>ELF parsing"]
        ArchMatch["Architecture matching<br/>runtime.GOARCH"]
        SymbolResolve["Symbol resolution<br/>PIE mode handling"]
    end
    
    subgraph "SSL-Specific"
        LibDetect["Library auto-detection<br/>System path search"]
        VersionCheck["SSL version detection"]
        CgroupSetup["CGroup path setup<br/>Process filtering"]
    end
    
    CheckStart --> ModelCheck
    ModelCheck --> PathCheck
    PathCheck --> PermCheck
    
    CheckStart --> BuildInfoRead
    BuildInfoRead --> ElfOpen
    ElfOpen --> ArchMatch
    ArchMatch --> SymbolResolve
    
    CheckStart --> LibDetect
    LibDetect --> VersionCheck
    VersionCheck --> CgroupSetup
```

**Sources:** [user/config/config_gotls.go:102-190](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gotls.go#L102-L190), [user/config/config_openssl_linux.go:69-103](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_openssl_linux.go#L69-L103), [user/config/config_gnutls_linux.go:27-63](https://github.com/gojue/ecapture/blob/0766a93b/user/config/config_gnutls_linux.go#L27-L63)

## Module Integration

Configuration objects are created and used by CLI commands and passed to modules:

```mermaid
graph LR
    subgraph "CLI Layer"
        Flags["CLI Flags<br/>cobra.Command"]
        ConfigNew["NewGoTLSConfig()<br/>Constructor"]
    end
    
    subgraph "Module Layer"  
        RunModule["runModule()<br/>Module orchestrator"]
        ProbeSetup["setupManagers()<br/>eBPF configuration"]
        EventMaps["Event map setup<br/>Based on model"]
    end
    
    Flags --> ConfigNew
    ConfigNew --> RunModule
    RunModule --> ProbeSetup
    ProbeSetup --> EventMaps
```

**Sources:** [cli/cmd/gotls.go:26-58](https://github.com/gojue/ecapture/blob/0766a93b/cli/cmd/gotls.go#L26-L58), [user/module/probe_gotls_text.go:31-118](https://github.com/gojue/ecapture/blob/0766a93b/user/module/probe_gotls_text.go#L31-L118), [user/module/probe_gotls_keylog.go:31-104](https://github.com/gojue/ecapture/blob/0766a93b/user/module/probe_gotls_keylog.go#L31-L104)